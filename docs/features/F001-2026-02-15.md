# F001 - st-dns 核心功能

> st-dns 的所有已实现核心功能，包括 DNS 服务器、缓存管理、智能解析等完整功能集。

**创建日期**: 2026-02-15
**最后更新**: 2026-02-15

---

## 功能概述

st-dns 是一个智能本地 DNS 服务器，支持可配置的多服务器 DNS 链（UDP/TCP/DoT），能够根据地理区域限制智能解析 IP，具有缓存和基于区域的优化能力。

---

## 状态信息

| 项目 | 内容 |
|------|------|
| **状态** | ✅ 已实现 |
| **优先级** | 高 |
| **负责人** | codingdie |
| **实际完成** | 2020-05-28 |

---

## 功能描述

### 1. DNS 服务器核心功能

#### 1.1 本地 DNS 服务
- **功能描述**: 提供标准 DNS 服务，监听本地 UDP 端口接收客户端查询
- **实现位置**: `src/core/dns_server.{h,cpp}`
- **核心能力**:
  - 监听本地 UDP 端口（默认 53）
  - 异步处理 DNS 查询请求
  - 创建和管理查询会话
  - 协调各组件完成查询
  - 构造和发送 DNS 响应

#### 1.2 会话管理
- **功能描述**: 为每个 DNS 查询创建独立会话，跟踪处理流程
- **实现位置**: `src/core/session.{h,cpp}`
- **会话类型**:
  - `QUERY`: 从缓存查询
  - `FORWARD`: 转发到上游
  - `DROP`: 丢弃请求
- **会话属性**:
  - 唯一会话 ID
  - 客户端地址
  - DNS 请求和响应
  - 解析记录
  - APM 日志

---

### 2. 上游 DNS 服务器管理

#### 2.1 多服务器链式查询
- **功能描述**: 支持配置多个上游 DNS 服务器，按顺序链式查询
- **实现位置**: `src/core/config.{h,cpp}`, `src/core/dns_client.{h,cpp}`
- **核心能力**:
  - 配置多个上游服务器
  - 每个服务器独立配置超时、缓存时间
  - 失败自动切换到下一个服务器
  - 支持服务器优先级排序

#### 2.2 智能服务器选择
- **功能描述**: 根据域名和地理区域自动选择合适的上游服务器
- **实现位置**: `src/core/config.cpp::remote_dns_server::select_servers()`
- **选择策略**:
  1. **域名白名单**: 只有匹配白名单的域名才使用该服务器
  2. **域名黑名单**: 匹配黑名单的域名不使用该服务器
  3. **地理区域限制**: 根据 IP 所属区域选择服务器
  4. **服务器顺序**: 按配置顺序优先级处理

#### 2.3 多协议支持
- **功能描述**: 支持 UDP、TCP、TCP+TLS (DoT) 三种协议查询上游服务器
- **实现位置**: `src/core/dns_client.{h,cpp}`
- **协议类型**:
  - **UDP**: 标准 DNS 查询，速度快但可能丢包
  - **TCP**: 可靠传输，适合大响应
  - **TCP_SSL (DoT)**: 加密传输，保护隐私

---

### 3. DNS 缓存系统

#### 3.1 两级缓存架构
- **功能描述**: 内存缓存 + LevelDB 持久化缓存，提升查询性能
- **实现位置**: `src/core/dns_record_manager.{h,cpp}`
- **缓存层级**:
  1. **内存缓存**: 快速访问，进程重启后丢失
  2. **LevelDB 缓存**: 持久化存储，进程重启后保留
- **缓存策略**:
  - 查询时先查内存缓存
  - 内存未命中则查 LevelDB
  - 添加记录时同时更新内存和 LevelDB
  - 定期清理过期记录

#### 3.2 缓存过期管理
- **功能描述**: 灵活的缓存过期���间配置
- **配置项**:
  - **全局过期时间**: `dns_cache_expire`（默认 600 秒）
  - **服务器级过期时间**: 每个服务器独立配置
- **过期计算**: 取服务器配置和全局配置的较小值

#### 3.3 缓存管理操作
- **功能描述**: 提供缓存的增删查改操作
- **支持的操作**:
  - `add()`: 添加 DNS 记录到缓存
  - `get_dns_record_list()`: 查询域名的所有记录
  - `resolve()`: 智能解析域名（合并多服务器记录）
  - `remove()`: 删除指定域名的缓存
  - `clear()`: 清空所有缓存
  - `stats()`: 获取缓存统计信息
  - `dump()`: 导出所有缓存数据

#### 3.4 缓存统计
- **功能描述**: 实时统计缓存数据
- **统计指标**:
  - `total_domain`: 总域名数
  - `trusted_domain`: 可信域名数
  - `total_ip`: 总 IP 数
  - `trusted_ip`: 可信 IP 数

---

### 4. 地理区域智能解析

#### 4.1 基于区域的 IP 过滤
- **功能描述**: 根据 IP 所属地理区域过滤和排序解析结果
- **实现位置**: `src/core/dns_record_manager.cpp::resolve()`
- **过滤规则**:
  1. **区域匹配优先**: 匹配目标区域的 IP 排在前面
  2. **禁止区域过滤**: 排除禁止区域的 IP
  3. **服务器顺序**: 相同条件下按服务器配置顺序排序

#### 4.2 区域 IP 查询接口
- **功能描述**: 通过第三方 API 查询 IP 所属地理区域
- **配置项**:
  ```json
  "area_ip_config": {
    "interfaces": [
      {
        "url": "http://ip.taobao.com/outGetIpInfo?ip={IP}&accessKey=alibaba-inc",
        "area_json_path": "data.country_id"
      },
      {
        "url": "http://ip-api.com/json/{IP}?lang=zh-CN",
        "area_json_path": "countryCode"
      }
    ]
  }
  ```
- **技术要点**:
  - 支持多个查询接口，失败自动切换
  - 使用 JSON Path 提取区域代码
  - 结果缓存避免重复查询

#### 4.3 区域解析优化
- **功能描述**: 与 st-proxy 配合，优化区域解析结果
- **配置项**: `area_resolve_optimize: true`
- **使用场景**: 需要 st-proxy 运行时启用

---

### 5. 反向 DNS 解析

#### 5.1 IP 到域名的反向查询
- **功能描述**: 支持通过 IP 查询对应的域名列表
- **实现位置**: `src/core/dns_record_manager.{h,cpp}`
- **接口**: `reverse_resolve(uint32_t ip)`
- **返回**: 域名列表
- **技术要点**:
  - 使用独立的 LevelDB 数据库存储反向索引
  - 每次添加 DNS 记录时自动更新反向索引
  - 支持一个 IP 对应多个域名

---

### 6. 强制域名解析规则

#### 6.1 域名模式匹配
- **功能描述**: 为特定域名模式配置固定的解析 IP
- **实现位置**: `src/core/config.{h,cpp}`
- **配置项**:
  ```json
  "force_resolve_rules": [
    {
      "pattern": "*.example.com",
      "ips": ["192.168.1.100", "192.168.1.101"]
    }
  ]
  ```
- **使用场景**:
  - 内网域名解析
  - 测试环境域名劫持
  - 广告屏蔽（解析到 0.0.0.0）

#### 6.2 规则匹配逻辑
- **匹配规则**:
  - 支持通配符 `*`
  - 精确匹配优先
  - 按配置顺序匹配

---

### 7. 远程记录同步

#### 7.1 异步记录同步
- **功能描述**: 从远程服务器异步同步 DNS 记录到本地缓存
- **实现位置**: `src/core/dns_server.cpp::sync_dns_record_from_remote()`
- **技术要点**:
  - 使用任务队列异步处理
  - 避免阻塞主查询流程
  - 支持多区域记录同步

#### 7.2 缺失记录补全
- **功能描述**: 当缓存记录不完整时，自动从远程补全
- **触发条件**:
  - 缓存中有记录但不完整
  - 需要更多区域的解析结果

---

### 8. 控制台管理

#### 8.1 运行时控制台
- **功能描述**: 提供运行时管理和查询接口
- **实现位置**: `src/core/dns_server.cpp::start_console()`
- **配置项**:
  - `console_ip`: 控制台绑定 IP（默认 127.0.0.1）
  - `console_port`: 控制台端口（默认 5757）
- **支持的命令**:
  - 查看缓存统计
  - 导出缓存数据
  - 清空缓存
  - 查看服务器状态

---

### 9. 日志系统

#### 9.1 多级日志
- **功能描述**: 支持多级日志输出
- **日志级别**:
  - `0`: DEBUG
  - `1`: INFO
  - `2`: WARN
  - `3`: ERROR
- **配置项**:
  ```json
  "log": {
    "level": 1,
    "tag": "st-dns"
  }
  ```

#### 9.2 远程日志服务器
- **功能描述**: 支持将日志发送到远程 UDP 服务器
- **配置项**:
  ```json
  "log": {
    "raw_log_server": {
      "ip": "192.168.31.20",
      "port": 30500,
      "TAG": "st-proxy"
    },
    "apm_log_server": {
      "ip": "192.168.31.20",
      "port": 30501,
      "TAG": "st-proxy"
    }
  }
  ```
- **日志类型**:
  - **raw_log**: 原始日志
  - **apm_log**: APM 性能监控日志

#### 9.3 APM 日志
- **功能描述**: 记录���个 DNS 查询的性能指标
- **记录指标**:
  - 查询域名
  - 查询类型
  - 处理时间
  - 缓存命中情况
  - 上游服务器信息

---

### 10. 配置管理

#### 10.1 JSON 配置文件
- **功能描述**: 使用 JSON 格式配置文件
- **实现位置**: `src/core/config.{h,cpp}`
- **配置文件**: `config.json`
- **配置搜索路径**（按顺序）:
  1. `-c` 参数指定的路径
  2. `../confs`（相对于可执行文件）
  3. `/usr/local/etc/st/dns`
  4. `/etc/st/dns`

#### 10.2 核心配置项
- `ip`, `port`: 本地服务绑定地址
- `servers`: 上游 DNS 服务器列表
- `dns_cache_expire`: 全局缓存过期时间
- `console_ip`, `console_port`: 控制台地址
- `log`: 日志配置
- `area_ip_config`: 区域 IP 查询配置
- `force_resolve_rules`: 强制解析规则

---

### 11. 守护进程模式

#### 11.1 服务管理
- **功能描述**: 支持以守护进程方式运行
- **实现位置**: `src/server/main.cpp`
- **支持的命令**:
  - `st-dns -d start`: 启动服务
  - `st-dns -d stop`: 停止服务
  - `st-dns -d restart`: 重启服务
- **技术要点**:
  - PID 文件管理（/var/run/st-dns.pid）
  - 调用 shell 脚本执行服务操作

#### 11.2 直接运行模式
- **命令**: `st-dns` 或 `st-dns -c /path/to/config`

---

### 12. DNS 协议支持

#### 12.1 协议解析
- **功能描述**: 完整的 DNS 协议解析和响应生成
- **实现位置**: `src/core/protocol/`
- **支持的查询类型**: A 记录（IPv4 地址）
- **支持的传输协议**:
  - UDP（标准 DNS）
  - TCP（大响应或可靠传输）
  - TCP+TLS（DoT，DNS over TLS）

---

### 13. 构建和测试

#### 13.1 CMake 构建系统
- **构建命令**:
  ```bash
  cmake -B build -DCMAKE_BUILD_TYPE=Release
  cmake --build build
  ```
- **构建选项**:
  - `CMAKE_BUILD_TYPE`: Debug/Release
  - `OPENWRT`: ON/OFF（OpenWrt 交叉编译）

#### 13.2 Protobuf 代码生成
- **proto 文件**:
  - `src/core/protocol/message.proto`: DNS 记录序列化
  - `src/common/main/proto/kv.proto`: KV 存储值包装

#### 13.3 测试系统
- **单元测试**: `src/test/unit/`
- **集成测试**: `src/test/integration/`
- **运行测试**: `cd build && ctest`

#### 13.4 OpenWrt 支持
- **软件包位置**: `../home-openwrt/codingdie-packages/packages/st-dns`
- **特殊处理**:
  - 禁用测试编译（`OPENWRT=ON` 时）
  - 使用 OpenWrt 特定配置文件

---

## 需求背景

### 问题描述

不同的 DNS 服务器有不同的特点：
1. **局域网 DNS**: 速度快，但只能解析内网域名
2. **国内 DNS**: 解析国内域名快，但国外域名可能被污染
3. **国外 DNS**: 解析国外域名准确，但国内域名可能慢

需要一个智能的 DNS 服务器，能够：
- 根据域名特点选择最合适的上游服务器
- 缓存查询结果提升性能
- 支持自定义解析规则
- 保护隐私，防止 DNS 污染

### 使用场景

**场景 1**: 本地开发环境
- 开发者在本地运行 st-dns
- 配置系统 DNS 为 127.0.0.1:53
- 所有应用的 DNS 查询都经过 st-dns 处理

**场景 2**: 路由器部署（OpenWrt）
- st-dns 部署在路由器上
- 局域网设备的 DNS 指向路由器
- 实现全局智能 DNS 解析

**场景 3**: 内外网混合解析
- 内网域名（*.local）→ ���域网 DNS
- 国内域名（*.cn）→ 国内 DNS
- 国外域名 → 国外 DoT（防污染）

---

## 技术方案

### 核心流程

```
客户端发起 DNS 查询
    ↓
DNS 服务器接收请求
    ↓
创建查询会话
    ↓
检查强制解析规则
    ├─ 匹配 → 直接返回强制 IP
    └─ 不匹配 ↓
查询缓存
    ├─ 查询内存缓存
    │   ├─ 命中且未过期 → 返回缓存结果
    │   └─ 未命中 ↓
    └─ 查询 LevelDB
        ├─ 命中且未过期 → 返回缓存结果
        └─ 未命中 ↓
选择上游服务器
    ├─ 检查域名白名单/黑名单
    ├─ 检查区域限制
    └─ 按顺序选择服务器
    ↓
查询上游服务器
    ├─ 建立连接（UDP/TCP/TLS）
    ├─ 发送 DNS 查询
    ├─ 接收响应
    └─ 解析 IP 列表
    ↓
更新缓存
    ├─ 更新内存缓存
    ├─ 更新 LevelDB
    └─ 更新反向索引
    ↓
构造 DNS 响应
    ↓
发送响应给客户端
    ↓
记录 APM 日志
    ↓
结束会话
```

### 关键技术点

1. **异步非阻塞**: 使用 Boost.Asio 实现高并发
2. **两级缓存**: 内存 + LevelDB，提升性能和可靠性
3. **智能路由**: 基于域名、区域的服务器选择
4. **多协议支持**: UDP/TCP/DoT
5. **持久化存储**: LevelDB 保证数据不丢失

---

## 配置项

### 完整配置示例

```json
{
  "ip": "127.0.0.1",
  "port": 53,
  "console_ip": "127.0.0.1",
  "console_port": 5757,
  "dns_cache_expire": 600,
  "servers": [
    {
      "type": "UDP",
      "ip": "192.168.31.1",
      "port": 53,
      "whitelist": ["*.local", "*.lan"],
      "areas": ["LAN"],
      "timeout": 500,
      "dns_cache_expire": 60
    },
    {
      "type": "TCP_SSL",
      "ip": "223.5.5.5",
      "port": 853,
      "areas": ["CN"],
      "timeout": 3000,
      "dns_cache_expire": 600
    },
    {
      "type": "TCP_SSL",
      "ip": "8.8.8.8",
      "port": 853,
      "blacklist": ["*.cn"],
      "areas": ["!CN"],
      "timeout": 20000,
      "dns_cache_expire": 600,
      "area_resolve_optimize": true
    }
  ],
  "force_resolve_rules": [
    {
      "pattern": "*.test.local",
      "ips": ["192.168.1.100"]
    }
  ],
  "area_ip_config": {
    "interfaces": [
      {
        "url": "http://ip.taobao.com/outGetIpInfo?ip={IP}&accessKey=alibaba-inc",
        "area_json_path": "data.country_id"
      },
      {
        "url": "http://ip-api.com/json/{IP}?lang=zh-CN",
        "area_json_path": "countryCode"
      }
    ]
  },
  "log": {
    "level": 1,
    "tag": "st-dns",
    "raw_log_server": {
      "ip": "192.168.31.20",
      "port": 30500,
      "TAG": "st-proxy"
    },
    "apm_log_server": {
      "ip": "192.168.31.20",
      "port": 30501,
      "TAG": "st-proxy"
    }
  }
}
```

### 配置说明

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `ip` | string | "127.0.0.1" | 本地绑定 IP |
| `port` | int | 53 | 本地端口 |
| `console_ip` | string | "127.0.0.1" | 控制台 IP |
| `console_port` | int | 5757 | 控制台端口 |
| `dns_cache_expire` | int | 600 | 全局缓存过期时间（秒） |
| `servers` | array | [] | 上游服务器列表 |
| `force_resolve_rules` | array | [] | 强制解析规则 |
| `area_ip_config` | object | {} | 区域 IP 查询配置 |
| `log` | object | {} | 日志配置 |

---

## 使用示例

### 示例 1: 基本使用

```bash
# 直接运行
st-dns

# 指定配置目录
st-dns -c /path/to/config

# 守护进程模式
sudo st-dns -d start
sudo st-dns -d stop
sudo st-dns -d restart
```

### 示例 2: 内外网分流配置

```json
{
  "ip": "0.0.0.0",
  "port": 53,
  "servers": [
    {
      "type": "UDP",
      "ip": "192.168.31.1",
      "port": 53,
      "whitelist": ["*.local", "*.lan"],
      "timeout": 500
    },
    {
      "type": "TCP_SSL",
      "ip": "223.5.5.5",
      "port": 853,
      "areas": ["CN"],
      "timeout": 3000
    },
    {
      "type": "TCP_SSL",
      "ip": "8.8.8.8",
      "port": 853,
      "areas": ["!CN"],
      "timeout": 10000
    }
  ]
}
```

### 示例 3: 防污染配置

```json
{
  "servers": [
    {
      "type": "UDP",
      "ip": "223.5.5.5",
      "port": 53,
      "blacklist": ["*.google.com", "*.youtube.com"],
      "timeout": 1000
    },
    {
      "type": "TCP_SSL",
      "ip": "8.8.8.8",
      "port": 853,
      "whitelist": ["*.google.com", "*.youtube.com"],
      "timeout": 5000
    }
  ]
}
```

---

## 测试用例

### 单元测试

- **测试文件**: `src/test/unit/`
- **测试内容**:
  - DNS 服务器启动和关闭
  - 缓存增删查改
  - 服务器选择逻辑
  - 域名匹配规则
  - 协议解析

### 集成测试

- **测试文件**: `src/test/integration/`
- **测试内容**:
  - 完整 DNS 查询流程
  - 多服务器查询
  - 缓存命中和未命中
  - 区域智能解析

### 运行测试

```bash
# 构建
cmake -B build -DCMAKE_BUILD_TYPE=Debug
cmake --build build

# 运行所有测试
cd build && ctest

# 运行单元测试
./st-unit-test
./st-dns-unit-test

# 运行集成测试
./st-dns-integration-test
```

---

## 注意事项

### 使用限制

- 监听 53 端口需要 root 权限（Linux/macOS）
- 同一端口只能有一个 DNS 服务器运行
- UDP 数据包大小限制为 512 字节（标准 DNS）

### 性能考虑

- 使用异步 I/O，支持高并发
- 缓存命中率直接影响性能
- DoT 服务器性能开销较大

### 安全考虑

- 需要验证 DNS 查询的合法性
- 建议配置防火墙规则
- DoT 服务器可以防止 DNS 劫持

### 兼容性

- 兼容标准 DNS 协议（RFC 1035）
- 支持 Linux、macOS、OpenWrt 平台
- 需要 Boost >= 1.66.0

---

## 相关文档

- [技术架构文档](../ARCHITECTURE.md)
- [README](../../README.md)
- [CLAUDE.md](../../CLAUDE.md)

---

## 参考资料

- [RFC 1035 - Domain Names - Implementation and Specification](https://tools.ietf.org/html/rfc1035)
- [RFC 7858 - DNS over TLS](https://tools.ietf.org/html/rfc7858)
- [Boost.Asio Documentation](https://www.boost.org/doc/libs/release/doc/html/boost_asio.html)

---

**维护者**: codingdie
**审核者**: -
