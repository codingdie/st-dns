# st-dns 开发流程规范

> 本文档定义 st-dns 项目的开发流程、规范和最佳实践。

**最后更新**: 2026-02-15

---

## 目录

- [功能开发流程](#功能开发流程)
- [功能状态管理](#功能状态管理)
- [功能文档规范](#功能文档规范)
- [代码开发规范](#代码开发规范)
- [测试规范](#测试规范)
- [Git 工作流](#git-工作流)
- [文档更新流程](#文档更新流程)

---

## 功能开发流程

### 完整流程

```
1. 创建功能文档
   ↓
2. 更新功能索引
   ↓
3. 通知 Claude 开发
   ↓
4. Claude 阅读文档
   ↓
5. Claude 自动开发代码
   ↓
6. Claude 编写测试
   ↓
7. Claude 运行测试
   ↓
8. 测试通过 → 更新文档状态
   ↓
9. 测试失败 → 修复问题 → 重新测试
```

### 详细步骤

#### 1. 创建功能文档

```bash
# 复制模板
cp docs/features/TEMPLATE.md docs/features/F{编号}-{年}-{月}-{日}.md

# 示例：创建 2026 年 2 月 15 日的第 2 个功能
cp docs/features/TEMPLATE.md docs/features/F002-2026-02-15.md

# 编辑文档，填写功能详情
vim docs/features/F002-2026-02-15.md
```

**必填内容**:
- 功能概述
- 状态信息
- 功能描述
- 需求背景
- 技术方案
- 实现位置
- 配置项
- 测试用例
- 使用示例

#### 2. 更新功能索引

在 `docs/FEATURES.md` 的功能列表中添加新功能条目：

```markdown
| F002 | 功能名称 | 📋 待开发 | 高 | 2026-02-15 | [features/F002-2026-02-15.md](features/F002-2026-02-15.md) |
```

#### 3. 通知 Claude 开发

告诉 Claude 功能文档路径，Claude 会：
1. 阅读功能文档
2. 理解需求和技术方案
3. 自动编写代码
4. 编写测试用例
5. 运行测试验证
6. 更新文档状态

**示例**:
```
请根据 docs/features/F002-2026-02-15.md 开发功能
```

#### 4. 开发完成后更新状态

将功能状态从 📋 待开发 改为 👀 待审核（详见[功能状态管理](#功能状态管理)），更新 `docs/FEATURES.md`：

```markdown
| F002 | 功能名称 | 👀 待审核 | 高 | 2026-02-15 | [features/F002-2026-02-15.md](features/F002-2026-02-15.md) |
```

---

## 功能状态管理

### 状态流程

功能开发过程中的状态变更流程：

- 📋 **待开发**: 功能文档已创建，等待开发
- 🚧 **开发中**: Claude 正在编码实现（Claude 维护）
- ✅ **开发完成**: 代码实现完成（Claude 维护）
- 🧪 **测试中**: Claude 正在测试验证（Claude 维护）
- ✅ **测试完成**: 测试通过（Claude 维护）
- 👀 **待审核**: 等待用户代码审核（Claude 维护）
- ✅ **已完成**: 审核通过，功能正式完成（**仅用户可修改**）

### 其他状态

- 🔄 **重构中**: 功能正在重构优化
- ⚠️ **已废弃**: 功能已不再使用

### 状态维护规则

**Claude 负责的状态转换**:
```
📋 待开发 → 🚧 开发中 → ✅ 开发完成 → 🧪 测试中 → ✅ 测试完成 → 👀 待审核
```

**用户负责的状态转换**:
```
👀 待审核 → ✅ 已完成（审核通过后）
```

### 状态更新时机

1. **开始开发**: 将状态从 📋 待开发 改为 🚧 开发中
2. **代码完成**: 将状态从 🚧 开发中 改为 ✅ 开发完成
3. **开始测试**: 将状态从 ✅ 开发完成 改为 🧪 测试中
4. **测试通过**: 将状态从 🧪 测试中 改为 ✅ 测试完成
5. **提交审核**: 将状态从 ✅ 测试完成 改为 👀 待审核
6. **审核通过**: 用户将状态从 👀 待审核 改为 ✅ 已完成

**重要**: Claude 不能将状态改为 ✅ 已完成，这是用户的专属权限。

---

## 功能文档规范

### 文档命名

**格式**: `F{编号}-{年}-{月}-{日}.md`

**示例**:
- `F001-2026-02-15.md` - 2026年2月15日创建的第1个功能
- `F002-2026-02-15.md` - 2026年2月15日创建的第2个功能

### 文档结构

每个功能文档必须包含以下部分：

1. **功能概述**: 简要描述功能（1-2句话）
2. **状态信息**: 状态、优先级、负责人、完成日期
3. **功能描述**: 详细描述功能需求和边界
4. **需求背景**: 问题描述、使用场景、预期收益
5. **技术方案**: 实现思路、核心流程、关键技术点、数据结构
6. **实现位置**: 新增文件、修改文件、核心类/函数
7. **配置项**: 配置文件、配置说明、配置示例
8. **API/接口**: 公共接口、内部接口
9. **测试用例**: 单元测试、集成测试、测试覆盖
10. **使用示例**: 基本使用、高级使用、配置示例
11. **注意事项**: 使用限制、性能考虑、安全考虑、兼容性
12. **相关功能**: 依赖功能、关联功能、后续功能

### 文档编写原则

- **清晰明确**: 避免模糊表述，使用具体的描述
- **完整详细**: 提供足够的信息，让 Claude 能够理解和实现
- **结构化**: 使用标题、列表、代码块等组织内容
- **示例丰富**: 提供配置示例、代码示例、使用示例
- **技术准确**: 确保技术方案可行，描述准确

### 禁止内容

- ❌ 不要包含开发日志（应在项目级别的 CHANGELOG 中维护）
- ❌ 不要包含具体的代码实现（应在代码文件中）
- ❌ 不要包含过时的信息（及时更新文档）

---

## 代码开发规范

### 代码风格

- **遵循现有代码风格**: 保持与项目一致
- **使用中文注释**: 代码注释使用中文
- **命名规范**:
  - 类名: PascalCase（如 `DnsServer`）
  - 函数名: snake_case（如 `process_session`）
  - 变量名: snake_case（如 `dns_client`）
  - 常量: UPPER_CASE（如 `MAX_TIMEOUT`）

### 代码组织

- **模块化**: 每个模块职责清晰，低耦合
- **单一职责**: 每个函数/类只做一件事
- **避免重复**: DRY 原则
- **简单优先**: 避免过度设计

### 错误处理

- **早失败**: 尽早检查参数和前置条件
- **明确错误**: 错误信息要清晰具体
- **记录日志**: 记录错误上下文
- **优雅降级**: 关键功能失败时有备选方案

### 性能考虑

- **异步非阻塞**: 使用 Boost.Asio 实现高并发
- **缓存优化**: 合理使用缓存
- **避免重复计算**: 缓存计算结果
- **资源管理**: 及时释放资源

### 安全考虑

- **输入验证**: 验证所有外部输入
- **防止注入**: 使用参数化查询
- **权限检查**: 验证操作权限
- **错误处理**: 避免泄露敏感信息

---

## 测试规范

### 测试类型

#### 单元测试
- **位置**: `src/test/unit/`
- **命名**: `test_{模块名}.cpp`
- **覆盖**: 核心业务逻辑、工具函数、独立模块

#### 集成测试
- **位置**: `src/test/integration/`
- **命名**: `test_{功能名}_integration.cpp`
- **覆盖**: 完整功能流程、模块间交互

### 测试命名

**格式**: `TEST(模块名, 测试场景_期望结果)`

**示例**:
```cpp
TEST(DnsServer, StartAndShutdown_Success)
TEST(DnsCache, AddRecord_UpdatesCache)
TEST(ServerSelection, WhitelistMatch_ReturnsServer)
```

### 测试覆盖

- [x] 正常流程测试
- [x] 边界条件测试
- [x] 异常情况测试
- [ ] 性能测试（可选）

### 运行测试

```bash
# 构建
cmake -B build -DCMAKE_BUILD_TYPE=Debug
cmake --build build

# 运行所有测试
cd build && ctest

# 运行单元测试
./st-unit-test
./st-dns-unit-test

# 运行集成测试
./st-dns-integration-test
```

---

## Git 工作流

### 分支管理

- **主分支**: `master` - 稳定版本
- **开发分支**: `develop` - 开发版本
- **功能分支**: `feature/{功能名}` - 新功能开发
- **修复分支**: `fix/{问题描述}` - Bug 修复

### 提交规范

**格式**: `<type>(<scope>): <subject>`

**Type 类型**:
- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建或辅助工具变动

**示例**:
```bash
feat(dns-server): 添加 IPv6 支持
fix(cache): 修复缓存过期时间计算错误
docs(features): 更新 F002 功能文档
```

### 提交流程

```bash
# 查看状态
git status

# 查看差异
git diff

# 添加文件
git add src/core/dns_server.cpp

# 提交（不要添加 Co-Authored-By）
git commit -m "feat(dns-server): 添加 IPv6 支持"

# 推送
git push origin develop
```

### 禁止操作

- ❌ 不要在 commit message 中添加 Co-Authored-By 标签
- ❌ 不要自动提交代码（等待用户明确说"提交"、"commit"或"push"）
- ❌ 不要直接推送到 master 分支
- ❌ 不要使用 `git push --force`（使用 `--force-with-lease`）

---

## 文档更新流程

### 功能文档更新

当功能发生变化时，必须同步更新功能文档：

1. **修改功能文档**: 更新相关章节
2. **更新状态**: 如果状态变化，更新功能索引
3. **提交变更**: 提交文档变更

### 架构文档更新

当架构发生重大变化时，更新 `docs/ARCHITECTURE.md`：

1. **更新架构图**: 如果组件关系变化
2. **更新模块说明**: 如果模块职责变化
3. **更新设计理念**: 如果设计原则变化

### README 更新

当项目信息变化时，更新 `README.md`：

1. **更新功能列表**: 新增或删除功能
2. **更新安装说明**: 依赖或安装步骤变化
3. **更新使用说明**: 使用方式变化

---

## Claude 开发注意事项

### 开发前

1. **仔细阅读功能文档**: 理解需求、技术方案、边界
2. **检查相关功能**: 了解依赖和关联功能
3. **查看现有代码**: 理解现有实现和代码风格

### 开发中

1. **遵循技术方案**: 按照文档中的技术方案实现
2. **保持代码风格**: 与现有代码保持一致
3. **编写测试**: 同步编写单元测试和集成测试
4. **记录日志**: 在关键位置添加日志

### 开发后

1. **运行测试**: 确保所有测试通过
2. **更新文档**: 如果实现与文档有差异，更新文档
3. **更新状态**: 将功能状态改为"已实现"

### 常见问题

**Q: 如果技术方案不可行怎么办？**
A: 与用户讨论，提出替代方案，更新功能文档后再实现。

**Q: 如果测试失败怎么办？**
A: 分析失败原因，修复问题，重新运行测试，直到通过。

**Q: 如果需要修改现有代码怎么办？**
A: 先阅读现有代码，理解实现逻辑，然后谨慎修改，确保不破坏现有功能。

---

## 最佳实践

### 功能开发

1. **小步快跑**: 将大功能拆分成小功能，逐步实现
2. **测试驱动**: 先写测试，再写实现
3. **持续集成**: 频繁提交，及时发现问题
4. **代码审查**: 重要功能需要审查

### 文档维护

1. **及时更新**: 代码变化时同步更新文档
2. **保持同步**: 文档与代码保持一致
3. **清晰准确**: 文档描述清晰准确
4. **示例丰富**: 提供足够的示例

### 质量保证

1. **代码质量**: 遵循代码规范，保持代码整洁
2. **测试覆盖**: 核心功能必须有测试
3. **性能优化**: 关注性能瓶颈
4. **安全加固**: 注意安全问题

---

**维护者**: codingdie
**联系方式**: codingdie@gmail.com
