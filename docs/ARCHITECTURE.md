# st-dns 技术架构文档

> 本文档描述 st-dns 项目的技术架构、核心组件和设计理念。

**最后更新**: 2026-02-15

---

## 目录

- [系统架构](#系统架构)
- [核心模块](#核心模块)
- [DNS 查询流程](#dns-查询流程)
- [线程模型](#线程模型)
- [数据存储](#数据存储)
- [网络通信](#网络通信)
- [目录结构](#目录结构)
- [依赖库](#依赖库)
- [设计理念](#设计理念)

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         客户端应用                            │
│                    (浏览器、系统应用等)                        │
└─────────────────────────┬───────────────────────────────────┘
                          │ DNS 查询 (UDP/TCP)
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                       st-dns 本地服务器                        │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                    DNS 服务器                          │  │
│  │              (主服务器，会话管理)                        │  │
│  └───────────┬──────────────────────┬────────────────────┘  │
│              │                      │                        │
│              ↓                      ↓                        │
│  ┌──────────────────┐    ┌──────────────────────┐          │
│  │   缓存管理器      │    │    DNS 客户端        │          │
│  │                  │    │  (上游查询)          │          │
│  │ ┌──────────────┐ │    │ ┌────────────────┐  │          │
│  │ │ 内存缓存      │ │    │ │ UDP 客户端     │  │          │
│  │ └──────────────┘ │    │ ├────────────────┤  │          │
│  │ ┌──────────────┐ │    │ │ TCP 客户端     │  │          │
│  │ │ LevelDB      │ │    │ ├────────────────┤  │          │
│  │ │ (持久化)      │ │    │ │ DoT 客户端     │  │          │
│  │ └──────────────┘ │    │ └────────────────┘  │          │
│  └──────────────────┘    └──────────────────────┘          │
│              │                      │                        │
│              │                      ↓                        │
│              │         ┌──────────────────────┐             │
│              │         │  上游 DNS 服务器      │             │
│              │         │  (UDP/TCP/DoT)       │             │
│              │         └──────────────────────┘             │
│              ↓                                               │
│  ┌──────────────────────────────────────────┐               │
│  │           配置管理器                      │               │
│  │  - 服务器列表                              │               │
│  │  - 区域配置                                │               │
│  │  - 强制解析规则                            │               │
│  └──────────────────────────────────────────┘               │
└─────────────────────────────────────────────────────────────┘
```

### 架构特点

1. **异步非阻塞**: 使用 Boost.Asio 实现异步 I/O
2. **多线程并发**: 主线程、客户端线程、缓存管理线程独立运行
3. **两级缓存**: 内存 + 持久化，提升性能和可靠性
4. **智能路由**: 基于域名、区域的智能上游服务器选择
5. **协议支持**: UDP/TCP/DoT 多协议支持

---

## 核心模块

### DNS 服务器模块

**职责**: 主服务器，管理 DNS 查询生命周期

**核心功能**:
- 监听本地 UDP 端口接收客户端查询
- 创建和管理查询会话
- 协调缓存查询和上游转发
- 提供控制台管理接口

**线程模型**:
- 主线程: UDP socket 接收循环
- 调度线程: 定时任务（统计、清理等）

---

### DNS 客户端模块

**职责**: 上游 DNS 查询客户端

**核心功能**:
- 向上游 DNS 服务器发起查询
- 支持 UDP/TCP/DoT 三种协议
- 管理连接池和超时
- SSL/TLS 加密通信

**线程模型**:
- 独立 io_context 线程处理所有上游查询
- 异步回调通知查询结果

**协议实现**:
- **UDP**: 简单快速，适合小响应
- **TCP**: 可靠传输，支持大响应
- **DoT**: 加密传输，保护隐私

---

### 缓存管理模块

**职责**: DNS 记录缓存管理

**核心功能**:
- 两级缓存（内存 + LevelDB）
- DNS 记录的增删查改
- 反向 DNS 索引维护
- 缓存统计和导出

**缓存策略**:
1. 查询时先查内存缓存
2. 内存未命中则查 LevelDB
3. 添加记录时同时更新内存和 LevelDB
4. 定期清理过期记录

**智能解析**:
- 合并多个服务器的查询结果
- 根据区域匹配度排序 IP
- 过滤禁止区域的 IP

---

### 会话管理模块

**职责**: DNS 查询会话管理

**核心功能**:
- 封装单次 DNS 查询的所有信息
- 跟踪查询处理流程
- APM 性能日志记录

**会话类型**:
- **QUERY**: 从缓存查询
- **FORWARD**: 转发到上游
- **DROP**: 丢弃请求

---

### 配置管理模块

**职责**: 系统配置管理

**核心功能**:
- 加载 JSON 配置文件
- 管理上游服务器列表
- 管理强制解析规则
- 区域 IP 配置

**配置内容**:
- 本地服务器绑定地址
- 上游服务器列表（IP、端口、协议、超时等）
- 域名白名单/黑名单
- 区域限制规则
- 强制解析规则

---

## DNS 查询流程

### 完整流程图

```
客户端发起 DNS 查询
    ↓
DNS 服务器接收请求
    ↓
创建查询会话
    ↓
检查强制解析规则
    ├─ 匹配 → 直接返回强制 IP
    └─ 不匹配 ↓
查询缓存
    ├─ 查询内存缓存
    │   ├─ 命中且未过期 → 返回缓存结果
    │   └─ 未命中 ↓
    └─ 查询 LevelDB
        ├─ 命中且未过期 → 返回缓存结果
        └─ 未命中 ↓
选择上游服务器
    ├─ 检查域名白名单/黑名单
    ├─ 检查区域限制
    └─ 按顺序选择服务器
    ↓
查询上游服务器
    ├─ 建立连接（UDP/TCP/TLS）
    ├─ 发送 DNS 查询
    ├─ 接收响应
    └─ 解析 IP 列表
    ↓
更新缓存
    ├─ 更新内存缓存
    ├─ 更新 LevelDB
    └─ 更新反向索引
    ↓
构造 DNS 响应
    ↓
发送响应给客户端
    ↓
记录 APM 日志
    ↓
结束会话
```

### 关键决策点

#### 1. 强制解析规则检查
- 优先级最高
- 匹配后直接返回，不查询缓存和上游
- 用于内网域名、测试环境、广告屏蔽等场景

#### 2. 缓存查询
- 先查内存，再查 LevelDB
- 检查过期时间
- 未命中才查询上游

#### 3. 服务器选择
- **白名单优先**: 只有匹配白名单的域名才使用该服务器
- **黑名单过滤**: 匹配黑名单的域名不使用该服务器
- **区域限制**: 根据配置的 areas 过滤
- **顺序优先**: 按配置顺序选择

#### 4. 结果排序
- 匹配区域的 IP 优先
- 非禁止区域的 IP 其次
- 服务器顺序最后

---

## 线程模型

### 线程架构

```
┌─────────────────────────────────────────────────────────┐
│                      主进程                              │
│                                                         │
│  ┌───────────────────────────────────────────────────┐ │
│  │  主线程 (DNS 服务器)                               │ │
│  │  - UDP socket 接收循环                             │ │
│  │  - 创建和管理会话                                  │ │
│  │  - 协调各组件工作                                  │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  ┌───────────────────────────────────────────────────┐ │
│  │  DNS 客户端线程                                    │ │
│  │  - 独立 io_context                                 │ │
│  │  - 处理所有上游 DNS 查询                           │ │
│  │  - 异步回调通知结果                                │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  ┌───────────────────────────────────────────────────┐ │
│  │  缓存管理线程                                      │ │
│  │  - 后台任务处理                                    │ │
│  │  - 定期统计和清理                                  │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  ┌───────────────────────────────────────────────────┐ │
│  │  调度线程                                          │ │
│  │  - 定时任务调度                                    │ │
│  │  - 缓存统计                                        │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  ┌───────────────────────────────────────────────────┐ │
│  │  任务队列线程                                      │ │
│  │  - 异步远程记录同步                                │ │
│  │  - 后台任务处理                                    │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 线程同步

- **LevelDB 访问**: LevelDB 本身线程安全
- **内存缓存**: 使用 mutex 保护共享数据
- **异步回调**: 使用 Boost.Asio 的 strand 或 post 确保线程安全

---

## 数据存储

### LevelDB 数据库

#### 主缓存数据库

**用途**: 存储 DNS 记录

**Key**: 域名 (string)
- 示例: `example.com`, `www.google.com`

**Value**: DNS 记录列表 (protobuf)
- 包含: IP 列表、过期时间、来源服务器、域名等

#### 反向索引数据库

**用途**: IP 到域名的反向查询

**Key**: IP 地址 (uint32_t，网络字节序)
- 示例: `192.168.1.1` → `0xC0A80101`

**Value**: 域名列表 (protobuf)
- 包含: 该 IP 对应的所有域名

### 数据持久化策略

- **写入策略**: 每次添加记录时同步写入 LevelDB
- **读取策略**: 先查内存，未命中再查 LevelDB
- **过期清理**: 定期扫描清理过期记录

---

## 网络通信

### UDP 通信

**用途**: 接收客户端查询、向上游发起 UDP 查询

**特点**:
- 无连接，速度快
- 可能丢包
- 响应大小限制（512 字节，EDNS 可扩展）

**适用场景**: 标准 DNS 查询，小响应

### TCP 通信

**用途**: 向上游发起 TCP 查询

**特点**:
- 面向连接，可靠传输
- 支持大响应
- 开销较大

**适用场景**: 大响应、需要可靠传输的查询

### DoT (DNS over TLS)

**用途**: 加密 DNS 查询

**特点**:
- 基于 TCP + TLS
- 保护隐私，防止劫持
- 性能开销较大

**TLS 配置**:
- 使用 OpenSSL
- 支持 TLS 1.2+
- 验证服务器证书

**适用场景**: 需要隐私保护的查询，防止 DNS 污染

---

## 目录结构

```
st-dns/
├── src/                        # 源代码
│   ├── core/                   # DNS 核心逻辑
│   │   ├── protocol/           # DNS 协议解析
│   │   └── ...                 # 服务器、客户端、缓存等模块
│   ├── common/main/            # 通用工具库
│   │   ├── kv/                 # KV 存储抽象
│   │   ├── proto/              # Protobuf 定义
│   │   ├── utils/              # 工具函数
│   │   ├── taskquque/          # 任务队列
│   │   ├── console/            # 控制台管理
│   │   ├── command/            # 命令处理
│   │   ├── area_ip/            # 区域 IP 查询
│   │   └── thirdpart/          # 第三方库
│   ├── server/                 # 服务器入口
│   └── test/                   # 测试代码
│       ├── unit/               # 单元测试
│       └── integration/        # 集成测试
├── confs/                      # 配置文件
│   ├── linux/                  # Linux 配置
│   └── openwrt/                # OpenWrt 配置
├── docs/                       # 文档
│   ├── features/               # 功能文档
│   │   ├── README.md           # 功能索引
│   │   ├── TEMPLATE.md         # 文档模板
│   │   └── F*.md               # 具体功能文档
│   └── ARCHITECTURE.md         # 本文件
├── CMakeLists.txt              # CMake 构建配置
├── install.sh                  # 安装脚本
├── README.md                   # 项目说明
└── CLAUDE.md                   # Claude 工作指南
```

### 模块划分

- **core/**: DNS 核心功能模块
  - 服务器、客户端、缓存、会话、配置等
  - DNS 协议解析和处理

- **common/main/**: 通用工具库
  - KV 存储、任务队列、工具函数等
  - 可被其他项目复用

- **server/**: 程序入口
  - main 函数、启动逻辑

- **test/**: 测试代码
  - 单元测试、集成测试

---

## 依赖库

### 核心依赖

| 库 | 版本要求 | 用途 |
|---|---------|------|
| **CMake** | >= 3.7.2 | 构建系统 |
| **Boost** | >= 1.66.0 | 网络 I/O、文件系统、线程、日志 |
| **OpenSSL** | >= 1.1.0 | TLS 加密 |
| **LevelDB** | - | 持久化存储 |
| **Protobuf** | - | 数据序列化 |
| **Curl** | - | HTTP 请求 |

### Boost 组件

- `boost::asio`: 异步 I/O
- `boost::filesystem`: 文件系统操作
- `boost::thread`: 线程管理
- `boost::program_options`: 命令行参数解析
- `boost::log`: 日志系统
- `boost::property_tree`: JSON 解析

---

## 设计理念

### 1. 高性能

- **异步非阻塞**: 使用 Boost.Asio 实现高并发
- **两级缓存**: 减少上游查询，提升响应速度
- **连接复用**: 复用 TCP/TLS 连接，减少握手开销

### 2. 高可靠

- **持久化缓存**: LevelDB 保证数据不丢失
- **多服务器冗余**: 支持多个上游服务器，失败自动切换
- **超时机制**: 所有网络操作都有超时保护

### 3. 智能路由

- **域名过滤**: 白名单/黑名单灵活控制
- **区域优化**: 根据 IP 地理位置智能选择
- **强制规则**: 支持自定义解析规则

### 4. 易扩展

- **模块化设计**: 各组件职责清晰，低耦合
- **配置驱动**: 通过配置文件灵活调整行为
- **插件化**: 支持扩展新的协议和功能

### 5. 易维护

- **清晰的代码结构**: 目录组织合理
- **完善的文档**: 功能文档、架构文档齐全
- **测试覆盖**: 单元测试和集成测试

---

## 性能优化策略

### 缓存优化

- **内存缓存**: 快速访问，减少磁盘 I/O
- **LevelDB 优化**: 使用 Bloom Filter 加速查询
- **过期清理**: 定期清理过期记录，减少内存占用

### 网络优化

- **连接池**: 复用 TCP/TLS 连接
- **并发查询**: 同时查询多个上游服务器
- **超时控制**: 避免慢查询阻塞

### 线程优化

- **独立 I/O 线程**: 避免阻塞主线程
- **任务队列**: 异步处理后台任务
- **无锁设计**: 尽量减少锁竞争

---

## 安全考虑

### 1. DoS 防护

- **速率限制**: 限制单个客户端的查询频率（待实现）
- **超时保护**: 所有操作都有超时限制
- **资源限制**: 限制缓存大小和并发连接数

### 2. 隐私保护

- **DoT 支持**: 加密 DNS 查询，防止劫持和窃听
- **本地缓存**: 减少对外查询，保护隐私

### 3. 数据安全

- **输入验证**: 验证 DNS 查询的合法性
- **错误处理**: 避免异常导致崩溃

---

## 扩展性设计

### 协议扩展

- 当前支持: UDP、TCP、DoT
- 易于添加: DoH (DNS over HTTPS)、DoQ (DNS over QUIC)

### 记录类型扩展

- 当前支持: A 记录 (IPv4)
- 易于添加: AAAA (IPv6)、CNAME、MX、TXT 等

### 功能扩展

- 插件化架构，支持添加新功能
- 配置驱动，无需修改代码

---

## 未来规划

### 短期目标

- 支持 IPv6 (AAAA 记录)
- 支持 DoH (DNS over HTTPS)
- 添加速率限制功能
- 优化缓存淘汰策略

### 长期目标

- 支持 DNSSEC
- 支持更多记录类型 (MX, CNAME, TXT 等)
- Web 管理界面
- 集群部署支持

---

**维护者**: codingdie
**联系方式**: codingdie@gmail.com
